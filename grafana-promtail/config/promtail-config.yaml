server:
  http_listen_port: 9081
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  - job_name: access
    static_configs:
    - targets:
        - localhost
      labels:
        job: access-log
        agent: promtail
        host: appfelstrudel
        __path__: /logs/*.access.log
    pipeline_stages:
    - replace:
          expression: '(?:[0-9]{1,3}\.){3}([0-9]{1,3})'
          replace: '***'

  - job_name: nginx-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx-error-log
          __path__: /logs/error.log
    pipeline_stages:
      - match:
          selector: '{job="nginx-error-log"}'
          stages:
            - regex:  # 使用正则选择要提取的字段
                expression: '^(?P<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\S+)\] (?P<pid>\d+)#(?P<tid>\d+): \*(?P<cid>\d+) (?P<msg>.*) client: (?P<client_ip>[^,]+), server: (?P<server_name>[^,]+), request: "(?P<request_method>\S+) (?P<request_path>\S+) (?P<request_protocol>\S+)", upstream: "(?P<upstream>[^"]+)", host: "(?P<host>[^"]+)"$'
            - labels:
                level:
                pid:
                tid:
                cid:
                client_ip:
                server_name:
                request_method:
                request_path:
                request_protocol:
                upstream:
                host:
            - timestamp:
                format: "2006/01/02 15:04:05"
                source: time  # 正则提取的字段
                location: Asia/Shanghai